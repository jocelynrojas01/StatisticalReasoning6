---
title: "Activity 14 - Stats Reasoning"
format: pdf
editor: visual
authors: Jocelyn Rojas & Seleona Hunter
---

# Loading Packages

```{r}
library(tidyverse) # For data wrangling
library(brms) # For stats
library(ggeffects) # for plotting model predictions
# Note: I needed to also install the `insight` and `see` packages to get `modelbased` to install properly; try that if you get similar error messages 
# install.packages('modelbased') # if you need to install this package
library(modelbased) # for plotting model predictions. supports the link scale (ggeffects does not)
# install.packages('faraway') # if you need to install this package
library(faraway) # For data on galapagos species richess

```

## Q1.1a and Q1.1b

1.  Counts of Clarkia flowers in a meadow

-   Values of response variables: Positive real numbers (can't have a negative number of flowers), could include zeros (there may not be any flowers)
-   Distribution: Normal distribution

2.  Whether or not a female elephant seal gives birth

-   Values of response variables: 0s and 1s (for yes: birth or no: did not give birth)
-   Distribution: Poisson distribution

3.  The percent cover of red algae in the intertidal

-   Values of response variables: fractions, positive numbers
-   Distribution: Binomial distribution

4.  Growth of a tree from one year to the next

-   Values of response variables: positive integers
-   Distribution: Normal distribution

5.  The spatial area of a forest in square meters

-   Values of response variables: integers, fractions
-   Distribution: Binomial distribution

#### Q1.2

1. Response variable for final project: rate of flock movement (through a forest)
2. Values of response variables: positive real numbers, integers
3. Distribution: Normal distribution

## 1.2 GLM with a log link

```{r}
# Read in the pre-stored data
data("gala")
# Check out the first 6 rows
head(gala)
# Look at the help page too!
?gala
```

## Q1.3 Plot a histogram of the response variable Endemics

```{r}

ggplot(data = gala, aes(x=Endemics)) +
  geom_histogram()

```
### Q1.3 Answer

This data does not appear to be normally distributed. The data seems to be skewed to the left with outliers far to the right in the graph.

## Q1.4 Plot Endemics ~ Elevation

```{r}
ggplot(data = gala, aes(x = Elevation,y = Endemics, color = Species )) +
  geom_point()
  labs(
    x = "Elevation",
    y = "Endemics"
  )
```
## Run the model

```{r}
# Endemics ~ Elevation
m.elev <- 
  brm(data = gala, # Give the model the penguins data
      # Choose a poisson distribution - THIS IS THE NEW PART!
      family = poisson(link = "log"),
      # Specify the model here. 
      Endemics ~ 1 + Elevation,
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/m.elev")
```
model summary
```{r}
plot(m.elev)
pairs(m.elev)
summary(m.elev)
```
## Q1.5 Evaluate the output

Based on the summary output, the model fitting algorithm did not converge. Our RHat value exceeds 1 and the chains do not align.

## Q1.6 Center the predictors

```{r}
gala <- gala |>
  mutate(Elevation_ctr = Elevation - mean(Elevation))

# Endemics ~ Elevation
m.elev2 <- 
  brm(data = gala, # Give the model the penguins data
      # Choose a poisson distribution - THIS IS THE NEW PART!
      family = poisson(link = "log"),
      # Specify the model here. 
      Endemics ~ 1 + Elevation_ctr,
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 6000, warmup = 4000, chains = 4, cores = 4,
      prior = prior(normal(0, 0.1), class = b),
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/m.elev2")
```
checking the model
```{r}
plot(m.elev2)
summary(m.elev2)
pairs(m.elev2)

# summary(m.elev2)
print(m.elev2, digits = 4) #alternative summary with more decimals
```

## Plot the posterior

```{r}
#plotting posterior predictions
preds <- estimate_expectation(m.elev2, by = 'Elevation_ctr') 
plot(preds, show_data = TRUE)
```

```{r}
# visualizing linear model
predslog <- estimate_expectation(m.elev2, by = 'Elevation_ctr', predict = 'link')
plot(predslog)
```

##Interpreting Link scale coeffs
```{r}
print(m.elev2, digits = 4)
```
1. Backtransform
```{r}
# backtransforming slope value
exp(0.0013)
```

2. Interpret 
```{r}
plot(preds, show_data = TRUE)

# for every 1m of elevation, you get an increase in 1.0013 times as many species as the previous meter.
```
##Q1.7 What is the percent change on the response scale?

1.    Number of Clarkias blooming as a function of temperature in Celsius: 1.09
```{r}
exp(1.09)
(2.974274 - 1)*100

# Back transformed: 197.4274% increase in number of Clarkias for every 1 degree increase in Celsius
```
2.    Density of sea urchins per square meter in a quadrat as a function of number of sea otters: -2.5
```{r}
(exp(-2.5) - 1)*100

# Back transformed: 0.082085

# For every increase in 1 sea otter there is a 91.7915% decrease in density of sea urchins per square meter. 
```

3.    Number of tomatoes per plant as a function of kg of fertilizer: 6.24
```{r}
exp(6.24)

(exp(6.24)-1)*100
# Back transformed: 512.8585 tomatoes per plant 

# For every increase in 1kg of fertilizer, there will be a 51185.85% increase in tomatoes per plant.
```

# DIY: Run a model of non-endemic species ~ distance from Santa Cruz Island

## Q1.8 Create a non-endemic column
```{r}
gala2 <- gala %>%
  mutate(non_Endemics = Species - Endemics)

# making a plot with new tibble
ggplot(data = gala2, aes(x = Scruz,y = non_Endemics, color = Species )) +
  geom_point()
  labs(
    x = "Santa Cruz Island (km)",
    y = "Non Endemic Species"
  )
```
## Q1.9 Run a model of non Endemics ~ distance from Santa Cruz Island

```{r}

#model for non edemics as function of distance from santa cruz islands
gala2model <- 
  brm(data = gala2, # Give the model the penguins data
      # Choose a poisson distribution - THIS IS THE NEW PART!
      family = poisson(link = "log"),
      # Specify the model here. 
      non_Endemics ~ 1 + Scruz,
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 6000, warmup = 4000, chains = 4, cores = 4,
      prior = prior(normal(0, 0.1), class = b),
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/gala2model")
```
## Q1.10 Evaluate the output

```{r}
plot(gala2model)
print(gala2model, digits = 4)
```
Our model ran correctly. The Rhat is 1, the chains overlap, and the posteriors are normally distributed. Our confidence intervals do not contain zero. 

## Q1.11 Interpret the output

1. The number of non endemic species decreases as distance from Santa Cruz island increases.
a. Original output on log scale: 0.0055 log(non-endemic species) 
b. Backtransformed:0.9945151 
```{r}
exp(-0.0055)
```

c. % change: For every 1 km increase in the distance from Santa Cruz island, there is a 0.54% decrease in non endemic species. 

```{r}
(exp(-0.0055)-1)*100
```

2. Yes it appears the slope estimate is different from zero because the confidence intervals do not contain zero. 

## Q1.12 Plot the posterior

```{r}
# log link scale
preds <- estimate_expectation(gala2model, by = 'Scruz') 
plot(preds, show_data = TRUE)
```

```{r}
# visualizing linear model
predslog <- estimate_expectation(gala2model, by = 'Scruz', predict = 'link')
plot(predslog)
```

# 1.3 GLM with a logit link

```{r}
# loading data
turtle <- faraway::turtle %>% 
  mutate(total_turtles = male + female,
         proportion_female = female/total_turtles)

# plotting data
turtle %>% 
  ggplot(aes(x = temp, y = proportion_female)) +
  geom_point()

```
```{r}
# running model 

m.turt <- 
  brm(data = turtle, # Give the model the data
      # Choose a binomial distribution - THIS IS THE NEW PART!
      family = binomial(link = "logit"),
      # Specify the model here. 
      female | trials(total_turtles) ~ 1 + temp,
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 4000, warmup = 1000, chains = 4, cores = 4,
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/m.turt")
```
```{r}
# model output
summary(m.turt)
plot(m.turt)
```
### Model interpretations

Our model ran correctly. The Rhat is 1, posteriors are normally distributed, the chains overlap, and the confidence intervals do no include zero.

### Interpreting plot predictions
```{r}
pred <- predict_response(m.turt, condition = c(total_turtles = 10))

plot(pred)
```

# 2. Multilevel models

## Q2.1 Fixed effects vs random effects
1. Student high school graduation rates as a function of: parental income, state of residence, and school district

- Fixed: state of residence, school district
- Random: parental income

2. Density of kelp as a function of: latitude, site, transect number, and density of sea urchins

- Fixed: latitude, transect number
- Random: density of sea urchins, site

3. Probability of whale giving birth as a function of: age, annual temperature, year, individual ID

- Fixed: individual ID, year 
- Random: age, annual temperature

# Random Effects

```{r}
# loading crab data

pie_crab <- lterdatasampler::pie_crab %>% 
  mutate(site = as.factor(site))
```

```{r}
pie_crab %>% 
  ggplot(aes(x = air_temp, y = size)) +
  geom_point()
```

```{r}
# running crab model
m.watertemp <- 
  brm(data = pie_crab, # Give the model the penguins data
      # Use a gamma distribution
      family = Gamma(link = "log"),
      # Specify the model here. 
      size ~ 1 + water_temp,
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/m.watertemp")

print(m.watertemp, digits = 3)
```
```{r}
#site as a random effect

m.watertemp.site <- 
  brm(data = pie_crab, # Give the model the penguins data
      # Use a gamma distribution
      family = Gamma(link = "log"),
      # Specify the model here. 
      size ~ 1 + water_temp + (1|site),
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/m.watertemp.site")

print(m.watertemp.site, digits = 3)
```
## Q2.2 What is the effect of water_temp on crab size on the response scale?

1. What is the effect of water_temp on crab size? 

a) original output on the log scale: -0.039

b) your backtransformed value
```{r}
exp(-0.039)
```

c) the percent change that this translates to. Describe the effect using the proper units.

For every 1 degree Celsius increase in water temperature, there crab size decrease by 3.82%. 
```{r}
(exp(-0.039)-1)*100
```

2. Does it seem like the slope estimate is different from zero? Why?

Yes, the confidence interval for slope does not include zero. 

## Q2.3 Compare WAIC and PSIS of the two models

The model including water temperature and site was better predictive power that the model that only included water temperature. 

```{r}
loo(m.watertemp.site)
loo(m.watertemp)

waic(m.watertemp.site)
waic(m.watertemp)
```

# Predict response of random effects
```{r}
preds <- predict_response(m.watertemp.site,
                          interval = "prediction",
                          terms = "site",
                          type = "random")

plot(preds)
```

